name: 'Maven Verify'
description: '–ó–∞–ø—É—Å–∫ Maven verify —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–µ–∫, –ø—Ä–æ—Ñ–∏–ª–µ–π, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è'
author: 'demid1984'
branding:
  icon: 'package'
  color: 'blue'

inputs:
  java-version:
    description: '–í–µ—Ä—Å–∏—è Java (–Ω–∞–ø—Ä–∏–º–µ—Ä, 17, 21)'
    required: true
  distribution:
    description: '–î–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ Java (–Ω–∞–ø—Ä–∏–º–µ—Ä, temurin, adopt)'
    required: true
  m2-settings:
    description: '–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É `settings.xml` –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)'
    required: false
    default: ''
  profile-name:
    description: '–ò–º—è Maven-–ø—Ä–æ—Ñ–∏–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)'
    required: false
    default: ''
  maven-args:
    description: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è Maven (–Ω–∞–ø—Ä–∏–º–µ—Ä, `-DskipTests`)'
    required: false
    default: ''
  env-vars-multiline:
    description: |
      –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `KEY=VALUE` (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É).
      –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å `#`, –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
    required: false
    default: ''
  cache-key:
    description: |
      –ö–ª—é—á –∫—ç—à–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Maven. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ.
      –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á, –æ—Ç—Ä–∞–∂–∞—é—â–∏–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, `deps-v1`).
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: üì¶ Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        fetch-depth: 0

    - name: üß™ Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ inputs.java-version }}
        distribution: ${{ inputs.distribution }}

    - name: üîß Set environment variables
      id: set-env
      shell: bash
      run: |
        ENV_VARS='${{ inputs.env-vars-multiline }}'

        if [[ -n "$ENV_VARS" ]]; then
          echo "::group::‚öôÔ∏è  Parsing and exporting environment variables"
          IFS=$'\n'
          for line in $ENV_VARS; do
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            trimmed=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            [[ -z "$trimmed" || "$trimmed" =~ ^# ]] && continue

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ `=` –≤ –∑–Ω–∞—á–µ–Ω–∏–∏)
            key="${line%%=*}"
            value="${line#*=}"

            if [[ -z "$key" ]]; then
              echo "::warning::–ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞: '$line' ‚Äî –ø—É—Å—Ç–æ–π –∫–ª—é—á"
              continue
            fi

            echo "$key=$value" >> "$GITHUB_ENV"
            echo "‚úÖ $key"
          done
          unset IFS
          echo "::endgroup::"
        else
          echo "‚ÑπÔ∏è  –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω—ã"
        fi

    - name: üì¶ Cache Maven dependencies
      if: inputs.cache-key != ''
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: maven-${{ runner.os }}-${{ inputs.cache-key }}-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          maven-${{ runner.os }}-${{ inputs.cache-key }}-

    - name: ‚öôÔ∏è Run Maven verify
      shell: bash
      run: |
        CMD="./mvnw -U verify"

        # –î–æ–±–∞–≤–ª—è–µ–º settings.xml, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if [[ -n "${{ inputs.m2-settings }}" && -f "${{ inputs.m2-settings }}" ]]; then
          CMD="$CMD -s ${{ inputs.m2-settings }}"
          echo "‚ÑπÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è settings.xml: ${{ inputs.m2-settings }}"
        elif [[ -n "${{ inputs.m2-settings }}" ]]; then
          echo "::warning::–£–∫–∞–∑–∞–Ω–Ω—ã–π —Ñ–∞–π–ª settings.xml –Ω–µ –Ω–∞–π–¥–µ–Ω: ${{ inputs.m2-settings }}"
        fi

        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω
        if [[ -n "${{ inputs.profile-name }}" ]]; then
          CMD="$CMD -P ${{ inputs.profile-name }}"
        fi

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
        if [[ -n "${{ inputs.maven-args }}" ]]; then
          CMD="$CMD ${{ inputs.maven-args }}"
        fi

        echo "üöÄ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: $CMD"
        $CMD